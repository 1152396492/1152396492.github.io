<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>P2P群聊系统 - Amentiraz blog</title>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="description" content="分布式作业">
<meta property="og:type" content="article">
<meta property="og:title" content="P2P群聊系统">
<meta property="og:url" content="http://1152396492.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="Amentiraz blog">
<meta property="og:description" content="分布式作业">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://1152396492.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/1.png">
<meta property="og:image" content="http://1152396492.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/2.png">
<meta property="og:image" content="http://1152396492.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/3.png">
<meta property="og:image" content="http://1152396492.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/4.png">
<meta property="og:image" content="http://1152396492.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/5.png">
<meta property="og:image" content="http://1152396492.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/6.png">
<meta property="og:image" content="http://1152396492.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/7.png">
<meta property="og:image" content="http://1152396492.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/8.jpg">
<meta property="og:image" content="http://1152396492.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/8.png">
<meta property="article:published_time" content="2024-06-03T10:39:18.000Z">
<meta property="article:modified_time" content="2024-06-03T03:27:29.851Z">
<meta property="article:author" content="Amentiraz">
<meta property="article:tag" content="代码">
<meta property="article:tag" content="分布式">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://1152396492.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/1.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css,npm/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,npm/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css?v=233" crossorigin>
    <link rel="stylesheet" href="/css/style.css?v=1727008967224">
    
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1727008967224">
<meta name="generator" content="Hexo 6.0.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(https://i.postimg.cc/XNHkwZh8/wallhaven-pkw6y3.jpg)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="Amentiraz" class="mdui-btn mdui-btn-icon"><img src="https://i.postimg.cc/P5FyTCbJ/20220606230333.jpg" alt="Amentiraz"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="Amentiraz">
            <img src="https://i.postimg.cc/P5FyTCbJ/20220606230333.jpg" alt="Amentiraz" alt="Amentiraz">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>36</div>
        <div><span>标签</span>28</div>
        <div><span>分类</span>6</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:nexmoe.com" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://jq.qq.com/?_wv=1027&k=5CfKHun" target="_blank" mdui-tooltip="{content: 'QQ群'}" style="color: rgb(249, 174, 8);background-color: rgba(249, 174, 8, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://space.bilibili.com/20238211" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/nexmoe/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/代码/">代码</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/学习笔记/">学习笔记</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/数学建模/">数学建模</a>
          <span class="category-list-count">4</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/生活/">生活</a>
          <span class="category-list-count">15</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/算法/">算法</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/论文/">论文</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


    
    
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 14px;">C语言</a> <a href="/tags/DP/" style="font-size: 10px;">DP</a> <a href="/tags/Dijkstra/" style="font-size: 10px;">Dijkstra</a> <a href="/tags/LCA/" style="font-size: 10px;">LCA</a> <a href="/tags/Matlab/" style="font-size: 10px;">Matlab</a> <a href="/tags/TOPSIS/" style="font-size: 12px;">TOPSIS</a> <a href="/tags/Tarjan/" style="font-size: 10px;">Tarjan</a> <a href="/tags/c%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">c语言</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/%E4%B9%A6%E8%AF%84/" style="font-size: 16px;">书评</a> <a href="/tags/%E4%BB%A3%E7%A0%81/" style="font-size: 14px;">代码</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 14px;">分布式</a> <a href="/tags/%E5%A4%8D%E4%B9%A0%E8%B5%84%E6%96%99/" style="font-size: 10px;">复习资料</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 16px;">学习笔记</a> <a href="/tags/%E5%B1%82%E6%AC%A1%E5%88%86%E6%9E%90%E6%B3%95/" style="font-size: 10px;">层次分析法</a> <a href="/tags/%E6%8C%87%E9%92%88/" style="font-size: 10px;">指针</a> <a href="/tags/%E6%8F%92%E5%80%BC%E7%AE%97%E6%B3%95/" style="font-size: 10px;">插值算法</a> <a href="/tags/%E6%95%B0%E5%AD%A6%E5%BB%BA%E6%A8%A1/" style="font-size: 16px;">数学建模</a> <a href="/tags/%E6%9D%82/" style="font-size: 10px;">杂</a> <a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size: 20px;">生活</a> <a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">笔记</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 18px;">算法</a> <a href="/tags/%E7%BA%BF%E6%AE%B5%E6%A0%91/" style="font-size: 10px;">线段树</a> <a href="/tags/%E7%BB%93%E6%9E%84/" style="font-size: 10px;">结构</a> <a href="/tags/%E8%AE%BA%E6%96%87/" style="font-size: 10px;">论文</a> <a href="/tags/%E8%AF%97/" style="font-size: 10px;">诗</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 12px;">读书笔记</a> <a href="/tags/%E9%A2%98%E8%A7%A3/" style="font-size: 10px;">题解</a>
    </div>
    
  </div>

    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2024 Amentiraz
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br><a target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"><img src="https://i.dawnlab.me/c0268c1e6cfd0863d6ba35be1575941a.png" width="150px"></a><script data-ad-client="ca-pub-2058306854838448" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
      
          <div class="nexmoe-post-cover" style="padding-bottom: 66.66666666666666%;"> 
              <img data-src="https://i.postimg.cc/XNHkwZh8/wallhaven-pkw6y3.jpg" data-sizes="auto" alt="P2P群聊系统" class="lazyload">
              <h1>P2P群聊系统</h1>
          </div>
      
      
      <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2024年06月03日</a>
    <a><i class="nexmoefont icon-areachart"></i>2.9k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 15 分钟</a>
</div>

      

      <p>分布式作业</p>
<span id="more"></span>
<h1 id="问题重述"><a href="#问题重述" class="headerlink" title="问题重述"></a>问题重述</h1><p><img src="/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/1.png"></p>
<h1 id="实验原理"><a href="#实验原理" class="headerlink" title="实验原理"></a>实验原理</h1><h2 id="全序广播协议"><a href="#全序广播协议" class="headerlink" title="全序广播协议"></a>全序广播协议</h2><p><img src="/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/2.png"></p>
<p>采用一个服务端，多个客户端的方法，当客户端收到服务端传来的信息时，判断该信息属于ACK信息、新加入客户端信息还是message消息。</p>
<p>如果这条信息是属于ACK信息，将对应消息m的ACK+1,观察队列头部的消息，如果关于该消息已经收到了所有节点的ACK消息，则将其从队列中取出，并完成投递。</p>
<p>如果这条信息属于发送的信息,将消息按逻辑时间戳先后顺序放入缓存队列,观察缓存队列头部的消息，如果该消息尚未广播过ACK消息，则向所有节点发送关于该消息的ACK信息.</p>
<p>具体实现如下图代码所示</p>
<p><img src="/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/3.png"></p>
<h2 id="因果关系"><a href="#因果关系" class="headerlink" title="因果关系"></a>因果关系</h2><p><img src="/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/4.png"></p>
<p>当客户端收到一条消息就将自己的时间戳与该信息的时间戳相比较，更新为更大的值实现因果关系的同一。</p>
<p>具体实现如下<br><img src="/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/5.png"></p>
<h2 id="传递消息"><a href="#传递消息" class="headerlink" title="传递消息"></a>传递消息</h2><p>采用socket传递消息</p>
<h2 id="雪花算法"><a href="#雪花算法" class="headerlink" title="雪花算法"></a>雪花算法</h2><p><img src="/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/6.png"></p>
<p>为Server提供信息的ID号</p>
<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><h2 id="软件版本"><a href="#软件版本" class="headerlink" title="软件版本"></a>软件版本</h2><p>Windows11<br>Eclipse IDE for Java Developers - 2022-03<br>Java 1.8<br>Maven3.6.1<br>Gson2.8.5</p>
<p><img src="/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/7.png"></p>
<h2 id="pom环境"><a href="#pom环境" class="headerlink" title="pom环境"></a>pom环境</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.ls<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>p2psystem<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <br>  	<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.code.gson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>gson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  	<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  	<br>  	<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.glassfish.tyrus.bundles<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tyrus-standalone-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  	<br>  	<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>  <br>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h1 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h1><h2 id="构架图"><a href="#构架图" class="headerlink" title="构架图"></a>构架图</h2><p><img src="/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/8.jpg"></p>
<h2 id="各个代码的用途"><a href="#各个代码的用途" class="headerlink" title="各个代码的用途"></a>各个代码的用途</h2><h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><p>接受服务端的信息，处理终端和前端UI的信息，将最终信息传递给TextSaverApp进行展示。</p>
<h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p>不断接收来自PORT端口的信息，并将信息传给所有的Client节点，值得主义的是由于messageID是唯一的，所以需要进行锁操作，我采用了Java中的synchronized函数对此变量进行锁操作。</p>
<h3 id="TextSaverAPP"><a href="#TextSaverAPP" class="headerlink" title="TextSaverAPP"></a>TextSaverAPP</h3><p>对文本框接收到的信息进行处理并传递给Server服务器；对从Client收到的信息进行展示。</p>
<h3 id="MessageUtils-Message"><a href="#MessageUtils-Message" class="headerlink" title="MessageUtils\Message"></a>MessageUtils\Message</h3><p>对信息进行定义并执行序列化和反序列化操作</p>
<h3 id="MessageQueue"><a href="#MessageQueue" class="headerlink" title="MessageQueue"></a>MessageQueue</h3><p>对信息进行存储、删除、记录次数操作，并利用优先队列对信息进行排序。</p>
<h3 id="SnowflakeIdGenerator"><a href="#SnowflakeIdGenerator" class="headerlink" title="SnowflakeIdGenerator"></a>SnowflakeIdGenerator</h3><p>生成信息的ID号</p>
<h1 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h1><p>mvn clean<br>mvn compile</p>
<p>mvn exec:java -Dexec.mainClass&#x3D;”p2psystem.Server”</p>
<p>mvn exec:java -Dexec.mainClass&#x3D;”p2psystem.Client”</p>
<h1 id="JAVA程序"><a href="#JAVA程序" class="headerlink" title="JAVA程序"></a>JAVA程序</h1><h2 id="Client-java"><a href="#Client-java" class="headerlink" title="Client.java"></a>Client.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">package</span> p2psystem;<br><br><span class="hljs-keyword">import</span> java.io.* ;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><span class="hljs-keyword">import</span> com.google.gson.Gson; <br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> </span>&#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SEVERADDRESS = <span class="hljs-string">&quot;127.0.0.1&quot;</span> ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> PORT = <span class="hljs-number">8189</span> ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> clientNum = <span class="hljs-number">1</span> ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> logicNum = <span class="hljs-number">1</span> ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Gson gson = <span class="hljs-keyword">new</span> Gson() ;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ACKseq = <span class="hljs-number">1145141919</span> ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ACKnew = <span class="hljs-number">1919810</span> ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> MessageQueue Mqueue = <span class="hljs-keyword">new</span> MessageQueue ( ) ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TextSaverApp chat = <span class="hljs-keyword">new</span> TextSaverApp(<span class="hljs-string">&quot;chatgroup&quot;</span>) ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> ClientName ;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> ACKname = <span class="hljs-number">0</span> ; <br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span> <span class="hljs-params">( String [] args )</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">// 定义socket,输入输出变量</span><br>        Socket socket = <span class="hljs-keyword">new</span> Socket ( SEVERADDRESS , PORT ) ; <br>        BufferedReader in = <span class="hljs-keyword">new</span> BufferedReader ( <span class="hljs-keyword">new</span> InputStreamReader ( socket.getInputStream() ) ) ; <br>        PrintWriter out = <span class="hljs-keyword">new</span> PrintWriter ( socket.getOutputStream() , <span class="hljs-keyword">true</span> ) ; <br>        BufferedReader consoleInput = <span class="hljs-keyword">new</span> BufferedReader ( <span class="hljs-keyword">new</span> InputStreamReader ( System.in ) ) ; <br>        <span class="hljs-comment">// 创造一个不断接受服务端信息的进程</span><br>        <span class="hljs-keyword">new</span> Thread ( ( ) -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                String serverMessageJson ; <br>                <span class="hljs-keyword">while</span> ( ( serverMessageJson = in.readLine() ) != <span class="hljs-keyword">null</span> ) &#123;<br>                    Message message = MessageUtils.deserialize(serverMessageJson) ; <br>                    <span class="hljs-comment">// 如果这条信息是属于ACK信息</span><br>                    <span class="hljs-comment">// 将对应消息m的ACK+1</span><br>                    <span class="hljs-comment">// 观察队列头部的消息，如果关于该消息已经收到了所有节点的ACK消息，则将其从队列中取出，并完成投递</span><br>                    <span class="hljs-keyword">if</span> ( message.getseq() == ACKseq ) &#123;<br>                        <span class="hljs-comment">//Mqueue.printAllMessages();</span><br>                        Mqueue.incrementIdCount(message) ; <br>                        Message HeadMessage = Mqueue.getHeadMessage() ; <br>                        <span class="hljs-keyword">int</span> count = Mqueue.getMessageCount(HeadMessage.getId()) ; <br>                        <span class="hljs-keyword">if</span> ( count == clientNum ) &#123;<br>                            logicNum = logicNum + <span class="hljs-number">1</span> ; <br>                            chat.setLogicNum(logicNum) ;<br>                            Mqueue.removeMessage(HeadMessage.getId()) ; <br>                            <span class="hljs-comment">//传递给应用层</span><br>                            chat.appendText(ClientName + <span class="hljs-string">&quot;:&quot;</span> + HeadMessage.toString());<br>                            System.out.println ( HeadMessage.toString() ) ; <br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-comment">// 处理新来的客户端</span><br>                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( message.getseq() == ACKnew ) &#123;<br>                        logicNum = logicNum + <span class="hljs-number">1</span> ; <br>                        chat.setLogicNum(logicNum) ;<br>                        clientNum = (<span class="hljs-keyword">int</span>)message.getId() ; <br>                        <span class="hljs-keyword">if</span> ( ACKname == <span class="hljs-number">0</span> ) &#123;<br>                            ACKname = <span class="hljs-number">1</span> ; <br>                            ClientName = clientNum ; <br>                        &#125;<br>                        System.out.println ( clientNum ) ; <br>                    &#125;<br>                    <span class="hljs-comment">// 如果这条信息属于发送的信息</span><br>                    <span class="hljs-comment">// 将消息按逻辑时间戳先后顺序放入缓存队列</span><br>                    <span class="hljs-comment">// 观察缓存队列头部的消息，如果该消息尚未广播过ACK消息，则向所有节点发送关于该消息的ACK信息</span><br>                    <span class="hljs-keyword">else</span> &#123; <br>                        Mqueue.addMessage(message) ;<br>                        <span class="hljs-comment">//Mqueue.printAllMessages();</span><br>                        <span class="hljs-comment">//System.out.println(message.toString());</span><br>                        Message HeadMessage = Mqueue.getHeadMessage() ; <br>                        <span class="hljs-keyword">int</span> count = Mqueue.getBroadCount(HeadMessage.getId()) ;<br>                        <span class="hljs-comment">//System.out.println ( count ) ; </span><br>                        <span class="hljs-keyword">if</span> ( count == <span class="hljs-number">0</span> ) &#123;<br>                            <span class="hljs-comment">// 发送ACK信息</span><br>                            Mqueue.incrementBroadCount(message) ; <br>                            Message Hmessage = <span class="hljs-keyword">new</span> Message ( message.getId() , ACKseq , message.getContent() )  ; <br>                            String messageJson = MessageUtils.serialize(Hmessage) ; <br>                            logicNum = Math.max(logicNum, message.getseq()) ; <br>                            logicNum = logicNum + <span class="hljs-number">1</span> ; <br>                            chat.setLogicNum(logicNum) ; <br>                            out.println(messageJson);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> ( IOException e ) &#123;<br>                e.printStackTrace() ; <br>            &#125;<br>        &#125;).start ( ) ; <br>        <span class="hljs-comment">// 告诉服务器有新客户端加入</span><br>        Message infoM = <span class="hljs-keyword">new</span> Message( <span class="hljs-number">0</span> , ACKnew , <span class="hljs-string">&quot;Hello&quot;</span>) ;<br>        String messageJso = MessageUtils.serialize(infoM) ; <br>        out.println ( messageJso ) ; <br>        <span class="hljs-comment">// 对面板输入的数据处理</span><br>        <span class="hljs-comment">// 对终端输入的数据进行处理</span><br>        String userInput ; <br>        <span class="hljs-keyword">while</span> ( (userInput = consoleInput.readLine()) != <span class="hljs-keyword">null</span> ) &#123;<br>            Message message = <span class="hljs-keyword">new</span> Message ( <span class="hljs-number">0</span> , logicNum , userInput ) ;<br>            String messageJson = MessageUtils.serialize(message) ; <br>            logicNum = logicNum + <span class="hljs-number">1</span> ; <br>            chat.setLogicNum(logicNum) ;<br>            out.println(messageJson);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Server-java"><a href="#Server-java" class="headerlink" title="Server.java"></a>Server.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">package</span> p2psystem;<br><br><span class="hljs-keyword">import</span> java.io.* ; <br><span class="hljs-keyword">import</span> java.net.* ; <br><span class="hljs-keyword">import</span> java.util.* ;<br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;<br><span class="hljs-keyword">import</span> com.google.gson.Gson; <br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Server</span> </span>&#123;<br>    <span class="hljs-comment">// 定义需要的全局变量</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> PORT = <span class="hljs-number">8189</span> ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> messageID = <span class="hljs-number">0</span> ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Integer,PrintWriter&gt; clientWriters = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;() ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Gson gson = <span class="hljs-keyword">new</span> Gson() ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SnowflakeIdGenerator idGenerator = <span class="hljs-keyword">new</span> SnowflakeIdGenerator ( <span class="hljs-number">1</span> , <span class="hljs-number">1</span> ) ;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ACKseq = <span class="hljs-number">1145141919</span> ;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ACKnew = <span class="hljs-number">1919810</span> ;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> clientNum = <span class="hljs-number">0</span> ;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span> <span class="hljs-params">( String[] args )</span> </span>&#123;<br>        System.out.println ( <span class="hljs-string">&quot;Central server started!&quot;</span>) ; <br>        <span class="hljs-keyword">try</span> ( ServerSocket serverSocket = <span class="hljs-keyword">new</span> ServerSocket ( PORT ) ) &#123;<br>            <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span> ; <br>            <span class="hljs-keyword">while</span> ( <span class="hljs-keyword">true</span> ) &#123;<br>                <span class="hljs-keyword">new</span> ClientHandler( serverSocket.accept() ).start() ; <br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> ( IOException e ) &#123;<br>            e.printStackTrace(); <br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> Socket socket ; <br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> clientID ; <br>        <span class="hljs-keyword">private</span> BufferedReader in ; <br>        <span class="hljs-keyword">private</span> PrintWriter out ; <br>        <br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClientHandler</span> <span class="hljs-params">( Socket socket )</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.socket = socket ; <br>        &#125;<br>        <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span> <span class="hljs-params">( )</span> </span>&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                BufferedReader in = <span class="hljs-keyword">new</span> BufferedReader ( <span class="hljs-keyword">new</span> InputStreamReader ( socket.getInputStream() ) ) ; <br>                PrintWriter out = <span class="hljs-keyword">new</span> PrintWriter ( socket.getOutputStream() , <span class="hljs-keyword">true</span> ) ; <br>                clientID = socket.getPort() ; <br>                clientWriters.put(clientID, out) ; <br>                <br>                String messageJson ; <br>                <span class="hljs-keyword">while</span> ( (messageJson = in.readLine()) != <span class="hljs-keyword">null</span> ) &#123;<br>                    <span class="hljs-comment">// synchronized用来锁这个相同同步块的线程，因为messageID时唯一的，只能有一个来进行写操作</span><br>                    <span class="hljs-keyword">synchronized</span> ( Server.class ) &#123;<br>                        Message message = MessageUtils.deserialize(messageJson);<br>                        <span class="hljs-keyword">if</span> ( message.getId() == <span class="hljs-number">0</span> )<br>                            message.setId ( idGenerator.nextId() ) ; <br>                        <span class="hljs-keyword">if</span> ( message.getseq() == ACKnew ) &#123;<br>                            message.setId((<span class="hljs-keyword">long</span>)clientNum+(<span class="hljs-keyword">long</span>)<span class="hljs-number">1</span>);<br>                            clientNum = clientNum + <span class="hljs-number">1</span> ; <br>                        &#125;<br>                        String broadcastMessage = MessageUtils.serialize(message) ; <br>                        <span class="hljs-keyword">for</span> ( PrintWriter writer : clientWriters.values() ) &#123;<br>                            writer.println ( broadcastMessage ) ; <br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> ( IOException e ) &#123;<br>                e.printStackTrace(); <br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> ( out != <span class="hljs-keyword">null</span> ) &#123;<br>                    clientWriters.remove(clientID) ; <br>                &#125;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    socket.close(); <br>                &#125; <span class="hljs-keyword">catch</span> ( IOException e ) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="SnowflakeldGenerator-java"><a href="#SnowflakeldGenerator-java" class="headerlink" title="SnowflakeldGenerator.java"></a>SnowflakeldGenerator.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">package</span> p2psystem;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SnowflakeIdGenerator</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> workerId;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> datacenterId;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> twepoch = <span class="hljs-number">1288834974657L</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> workerIdBits = <span class="hljs-number">5L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> datacenterIdBits = <span class="hljs-number">5L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> maxWorkerId = -<span class="hljs-number">1L</span> ^ (-<span class="hljs-number">1L</span> &lt;&lt; workerIdBits);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> maxDatacenterId = -<span class="hljs-number">1L</span> ^ (-<span class="hljs-number">1L</span> &lt;&lt; datacenterIdBits);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> sequenceBits = <span class="hljs-number">12L</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> workerIdShift = sequenceBits;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> datacenterIdShift = sequenceBits + workerIdBits;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> sequenceMask = -<span class="hljs-number">1L</span> ^ (-<span class="hljs-number">1L</span> &lt;&lt; sequenceBits);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> lastTimestamp = -<span class="hljs-number">1L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> sequence = <span class="hljs-number">0L</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SnowflakeIdGenerator</span><span class="hljs-params">(<span class="hljs-keyword">long</span> workerId, <span class="hljs-keyword">long</span> datacenterId)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (workerId &gt; maxWorkerId || workerId &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(String.format(<span class="hljs-string">&quot;worker Id can&#x27;t be greater than %d or less than 0&quot;</span>, maxWorkerId));<br>        &#125;<br>        <span class="hljs-keyword">if</span> (datacenterId &gt; maxDatacenterId || datacenterId &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(String.format(<span class="hljs-string">&quot;datacenter Id can&#x27;t be greater than %d or less than 0&quot;</span>, maxDatacenterId));<br>        &#125;<br>        <span class="hljs-keyword">this</span>.workerId = workerId;<br>        <span class="hljs-keyword">this</span>.datacenterId = datacenterId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">long</span> <span class="hljs-title">nextId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">long</span> timestamp = timeGen();<br><br>        <span class="hljs-keyword">if</span> (timestamp &lt; lastTimestamp) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(String.format(<span class="hljs-string">&quot;Clock moved backwards. Refusing to generate id for %d milliseconds&quot;</span>, lastTimestamp - timestamp));<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (lastTimestamp == timestamp) &#123;<br>            sequence = (sequence + <span class="hljs-number">1</span>) &amp; sequenceMask;<br>            <span class="hljs-keyword">if</span> (sequence == <span class="hljs-number">0</span>) &#123;<br>                timestamp = tilNextMillis(lastTimestamp);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            sequence = <span class="hljs-number">0L</span>;<br>        &#125;<br><br>        lastTimestamp = timestamp;<br><br>        <span class="hljs-keyword">return</span> ((timestamp - twepoch) &lt;&lt; timestampLeftShift) |<br>                (datacenterId &lt;&lt; datacenterIdShift) |<br>                (workerId &lt;&lt; workerIdShift) |<br>                sequence;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">long</span> <span class="hljs-title">tilNextMillis</span><span class="hljs-params">(<span class="hljs-keyword">long</span> lastTimestamp)</span> </span>&#123;<br>        <span class="hljs-keyword">long</span> timestamp = timeGen();<br>        <span class="hljs-keyword">while</span> (timestamp &lt;= lastTimestamp) &#123;<br>            timestamp = timeGen();<br>        &#125;<br>        <span class="hljs-keyword">return</span> timestamp;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">long</span> <span class="hljs-title">timeGen</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> System.currentTimeMillis();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="TextSaverApp"><a href="#TextSaverApp" class="headerlink" title="TextSaverApp"></a>TextSaverApp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">package</span> p2psystem;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.awt.*;<br><span class="hljs-keyword">import</span> java.awt.event.ActionEvent;<br><span class="hljs-keyword">import</span> java.awt.event.ActionListener;<br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.BufferedWriter;<br><span class="hljs-keyword">import</span> java.io.FileWriter;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><span class="hljs-keyword">import</span> java.net.UnknownHostException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TextSaverApp</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> JFrame frame;<br>    <span class="hljs-keyword">private</span> JTextArea textArea;<br>    <span class="hljs-keyword">private</span> JTextField textField;<br>    <span class="hljs-keyword">private</span> JButton sendButton;<br>    <span class="hljs-keyword">private</span> BufferedWriter writer;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SEVERADDRESS = <span class="hljs-string">&quot;127.0.0.1&quot;</span> ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> PORT = <span class="hljs-number">8189</span> ;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> logicNum = <span class="hljs-number">1</span> ;<br>    Socket socket ;<br>    BufferedReader in ; <br>    PrintWriter out ; <br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLogicNum</span> <span class="hljs-params">( <span class="hljs-keyword">int</span> logicNum )</span> </span>&#123; <br>        <span class="hljs-keyword">this</span>.logicNum = logicNum ; <br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TextSaverApp</span><span class="hljs-params">()</span> </span>&#123;<br>        setupUI();<br>        setupWriter(<span class="hljs-string">&quot;output.txt&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>        	socket = <span class="hljs-keyword">new</span> Socket ( SEVERADDRESS , PORT ) ; <br>        	in = <span class="hljs-keyword">new</span> BufferedReader ( <span class="hljs-keyword">new</span> InputStreamReader ( socket.getInputStream() ) ) ; <br>        	out = <span class="hljs-keyword">new</span> PrintWriter ( socket.getOutputStream() , <span class="hljs-keyword">true</span> ) ; <br>        &#125; <span class="hljs-keyword">catch</span> ( IOException e ) &#123;<br>        	e.getStackTrace() ; <br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TextSaverApp</span><span class="hljs-params">(String filePath)</span> </span>&#123;<br>        setupUI();<br>        setupWriter(filePath);<br>        <span class="hljs-keyword">try</span> &#123;<br>        	socket = <span class="hljs-keyword">new</span> Socket ( SEVERADDRESS , PORT ) ; <br>        	in = <span class="hljs-keyword">new</span> BufferedReader ( <span class="hljs-keyword">new</span> InputStreamReader ( socket.getInputStream() ) ) ; <br>        	out = <span class="hljs-keyword">new</span> PrintWriter ( socket.getOutputStream() , <span class="hljs-keyword">true</span> ) ; <br>        &#125; <span class="hljs-keyword">catch</span> ( IOException e ) &#123;<br>        	e.getStackTrace() ; <br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setupUI</span><span class="hljs-params">()</span> </span>&#123;<br>        frame = <span class="hljs-keyword">new</span> JFrame(<span class="hljs-string">&quot;Text Saver&quot;</span>);<br>        textArea = <span class="hljs-keyword">new</span> JTextArea(<span class="hljs-number">20</span>, <span class="hljs-number">50</span>);<br>        textField = <span class="hljs-keyword">new</span> JTextField(<span class="hljs-number">40</span>);<br>        sendButton = <span class="hljs-keyword">new</span> JButton(<span class="hljs-string">&quot;Send&quot;</span>);<br><br>        textArea.setEditable(<span class="hljs-keyword">false</span>);<br>        JPanel panel = <span class="hljs-keyword">new</span> JPanel();<br>        panel.setLayout(<span class="hljs-keyword">new</span> BorderLayout());<br>        panel.add(<span class="hljs-keyword">new</span> JScrollPane(textArea), BorderLayout.CENTER);<br><br>        JPanel inputPanel = <span class="hljs-keyword">new</span> JPanel();<br>        inputPanel.add(textField);<br>        inputPanel.add(sendButton);<br><br>        frame.getContentPane().add(panel, BorderLayout.CENTER);<br>        frame.getContentPane().add(inputPanel, BorderLayout.SOUTH);<br><br>        sendButton.addActionListener(<span class="hljs-keyword">new</span> ActionListener() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">actionPerformed</span><span class="hljs-params">(ActionEvent e)</span> </span>&#123;<br>                sendText();<br>            &#125;<br>        &#125;);<br><br>        textField.addActionListener(<span class="hljs-keyword">new</span> ActionListener() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">actionPerformed</span><span class="hljs-params">(ActionEvent e)</span> </span>&#123;<br>                sendText();<br>            &#125;<br>        &#125;);<br><br>        frame.pack();<br>        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);<br>        frame.setVisible(<span class="hljs-keyword">true</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setupWriter</span><span class="hljs-params">(String filePath)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            writer = <span class="hljs-keyword">new</span> BufferedWriter(<span class="hljs-keyword">new</span> FileWriter(filePath, <span class="hljs-keyword">true</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendText</span><span class="hljs-params">()</span> </span>&#123;<br>        String text = textField.getText();<br>        <span class="hljs-keyword">if</span> (!text.isEmpty()) &#123;<br>        	Message message = <span class="hljs-keyword">new</span> Message ( <span class="hljs-number">0</span> , logicNum , text ) ;<br>            String messageJson = MessageUtils.serialize(message) ; <br>            logicNum = logicNum + <span class="hljs-number">1</span> ; <br>            out.println(messageJson);<br>            textField.setText(<span class="hljs-string">&quot;&quot;</span>);<br>            <span class="hljs-comment">/*textArea.append(text + &quot;\n&quot;);</span><br><span class="hljs-comment">            </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">            try &#123;</span><br><span class="hljs-comment">                writer.write(text);</span><br><span class="hljs-comment">                writer.newLine();</span><br><span class="hljs-comment">                writer.flush();</span><br><span class="hljs-comment">            &#125; catch (IOException e) &#123;</span><br><span class="hljs-comment">                e.printStackTrace();</span><br><span class="hljs-comment">            &#125;*/</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">appendText</span><span class="hljs-params">(String text)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!text.isEmpty()) &#123;<br>            textArea.append(text + <span class="hljs-string">&quot;\n&quot;</span>);<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                writer.write(text);<br>                writer.newLine();<br>                writer.flush();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="MessageQueue-1"><a href="#MessageQueue-1" class="headerlink" title="MessageQueue"></a>MessageQueue</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">package</span> p2psystem;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageQueue</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> PriorityQueue&lt;Message&gt; messageQueue;<br>    <span class="hljs-keyword">private</span> Map&lt;Long, Integer&gt; idCounts;<br>    <span class="hljs-keyword">private</span> Map&lt;Long, Integer&gt; broadCounts;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MessageQueue</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// 初始化优先队列和ID计数器</span><br>        messageQueue = <span class="hljs-keyword">new</span> PriorityQueue&lt;&gt;(Comparator.comparingLong(Message::getseq));<br>        idCounts = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        broadCounts = <span class="hljs-keyword">new</span> HashMap&lt;&gt;() ; <br>    &#125;<br><br>    <span class="hljs-comment">// 添加消息到队列</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addMessage</span><span class="hljs-params">(Message message)</span> </span>&#123;<br>        messageQueue.offer(message); <span class="hljs-comment">// 添加到优先队列</span><br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">incrementBroadCount</span> <span class="hljs-params">( Message message )</span> </span>&#123;<br>    	broadCounts.put(message.getId(), <span class="hljs-number">1</span> ) ; <br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getBroadCount</span> <span class="hljs-params">( <span class="hljs-keyword">long</span> id )</span> </span>&#123; <br>    	<span class="hljs-keyword">return</span> broadCounts.getOrDefault(id, <span class="hljs-number">0</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">// 增加id的ACK计数</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">incrementIdCount</span> <span class="hljs-params">( Message message )</span> </span>&#123;<br>    	idCounts.put(message.getId(), idCounts.getOrDefault(message.getId(), <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>); <span class="hljs-comment">// 增加ID计数</span><br>    &#125;<br><br>    <span class="hljs-comment">// 删除指定ID的消息</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">removeMessage</span><span class="hljs-params">(<span class="hljs-keyword">long</span> id)</span> </span>&#123;<br>        <span class="hljs-comment">// 创建一个新的优先队列用于存储剩余的消息</span><br>        PriorityQueue&lt;Message&gt; newQueue = <span class="hljs-keyword">new</span> PriorityQueue&lt;&gt;(Comparator.comparingLong(Message::getseq));<br>        <span class="hljs-comment">// 从原队列中移除所有指定ID的消息，并更新ID计数</span><br>        <span class="hljs-keyword">while</span> (!messageQueue.isEmpty()) &#123;<br>            Message message = messageQueue.poll();<br>            <span class="hljs-keyword">if</span> (message.getId() != id) &#123;<br>                newQueue.offer(message); <span class="hljs-comment">// 将非指定ID的消息添加到新队列中</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                idCounts.put(id, <span class="hljs-number">0</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 更新队列为新队列</span><br>        messageQueue = newQueue;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 获取头部信息</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Message <span class="hljs-title">getHeadMessage</span> <span class="hljs-params">( )</span> </span>&#123;<br>    	<span class="hljs-keyword">return</span> messageQueue.peek() ; <br>    &#125;<br><br>    <span class="hljs-comment">// 获取队列中的所有消息</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Message&gt; <span class="hljs-title">getAllMessages</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(messageQueue);<br>    &#125;<br><br>    <span class="hljs-comment">// 获取指定ID的消息数量</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getMessageCount</span><span class="hljs-params">(<span class="hljs-keyword">long</span> id)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> idCounts.getOrDefault(id, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 打印队列中的所有消息</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">printAllMessages</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;All Messages in the Queue:&quot;</span>);<br>        <span class="hljs-keyword">for</span> (Message message : messageQueue) &#123;<br>            System.out.println(message.toString());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">package</span> p2psystem;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Message</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">1L</span> ; <br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> id ; <br>    <span class="hljs-keyword">private</span> String content ; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> seq ; <br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Message</span> <span class="hljs-params">( <span class="hljs-keyword">long</span> id , <span class="hljs-keyword">int</span> seq , String content )</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.id = id ; <br>        <span class="hljs-keyword">this</span>.seq = seq ; <br>        <span class="hljs-keyword">this</span>.content = content ; <br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getId</span> <span class="hljs-params">( )</span> </span>&#123; <span class="hljs-keyword">return</span> id ; &#125; <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span> <span class="hljs-params">( <span class="hljs-keyword">long</span> id )</span> </span>&#123; <span class="hljs-keyword">this</span>.id = id ; &#125; <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getseq</span> <span class="hljs-params">( )</span> </span>&#123; <span class="hljs-keyword">return</span> seq ; &#125; <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setseq</span> <span class="hljs-params">( <span class="hljs-keyword">int</span> seq )</span> </span>&#123; <span class="hljs-keyword">this</span>.seq = seq ; &#125; <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getContent</span> <span class="hljs-params">( )</span> </span>&#123; <span class="hljs-keyword">return</span> content ; &#125; <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setContent</span> <span class="hljs-params">( String content )</span> </span>&#123; <span class="hljs-keyword">this</span>.content = content ; &#125; <br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span> <span class="hljs-params">( )</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Message&#123;&quot;</span>+<br>                <span class="hljs-string">&quot;id=&quot;</span>+id+<br>                <span class="hljs-string">&quot;,seq=&quot;</span>+seq+<br>                <span class="hljs-string">&quot;,content=&#x27;&quot;</span>+content+<span class="hljs-string">&#x27;\&#x27;&#x27;</span>+<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="MessageUtils"><a href="#MessageUtils" class="headerlink" title="MessageUtils"></a>MessageUtils</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">package</span> p2psystem;<br><br><span class="hljs-keyword">import</span> com.google.gson.Gson;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageUtils</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Gson gson = <span class="hljs-keyword">new</span> Gson ( ) ; <br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">serialize</span> <span class="hljs-params">( Message message )</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> gson.toJson(message) ; <br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Message <span class="hljs-title">deserialize</span> <span class="hljs-params">( String json )</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> gson.fromJson(json, Message.class) ; <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h1><p><img src="/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/8.png"><br>当我们在文本框中输入想发送的信息后，点击Send该信息会在Client各自的显示界面中出现，对于不同文本框输入的值，我们可以发现Id号是严格递增的符合预期，Seq代表的逻辑序号也是递增的，符合我们实现的原理。可以看到在后台的命令指示符中各自的程序也都是良好的运行，符合预期！</p>

  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>Amentiraz<br>
        <strong>本文链接：</strong><a href="http://1152396492.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/" title="http:&#x2F;&#x2F;1152396492.github.io&#x2F;2024&#x2F;06&#x2F;03&#x2F;P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F&#x2F;" target="_blank" rel="noopener">http:&#x2F;&#x2F;1152396492.github.io&#x2F;2024&#x2F;06&#x2F;03&#x2F;P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/%E4%BB%A3%E7%A0%81/">代码</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/%E4%BB%A3%E7%A0%81/" rel="tag">代码</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag">分布式</a>
    
</div>

  
      <div class="nexmoe-post-footer">
          <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'd792bb4144ed2b426d10',
        clientSecret: '812d33a3a53d9f83437ed1e71c573a8b222a93f1',
        id: window.location.pathname,
        repo: '1152396492.github.io',
        owner: '1152396492',
        admin: '1152396492'
    })
    gitalk.render('gitalk')
</script>
</section>
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E9%87%8D%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">问题重述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">实验原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%BA%8F%E5%B9%BF%E6%92%AD%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.1.</span> <span class="toc-text">全序广播协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%A0%E6%9E%9C%E5%85%B3%E7%B3%BB"><span class="toc-number">2.2.</span> <span class="toc-text">因果关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E9%80%92%E6%B6%88%E6%81%AF"><span class="toc-number">2.3.</span> <span class="toc-text">传递消息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95"><span class="toc-number">2.4.</span> <span class="toc-text">雪花算法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">3.</span> <span class="toc-text">实验环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E7%89%88%E6%9C%AC"><span class="toc-number">3.1.</span> <span class="toc-text">软件版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pom%E7%8E%AF%E5%A2%83"><span class="toc-number">3.2.</span> <span class="toc-text">pom环境</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="toc-number">4.</span> <span class="toc-text">设计思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E6%9E%B6%E5%9B%BE"><span class="toc-number">4.1.</span> <span class="toc-text">构架图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%84%E4%B8%AA%E4%BB%A3%E7%A0%81%E7%9A%84%E7%94%A8%E9%80%94"><span class="toc-number">4.2.</span> <span class="toc-text">各个代码的用途</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Client"><span class="toc-number">4.2.1.</span> <span class="toc-text">Client</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Server"><span class="toc-number">4.2.2.</span> <span class="toc-text">Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TextSaverAPP"><span class="toc-number">4.2.3.</span> <span class="toc-text">TextSaverAPP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MessageUtils-Message"><span class="toc-number">4.2.4.</span> <span class="toc-text">MessageUtils\Message</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MessageQueue"><span class="toc-number">4.2.5.</span> <span class="toc-text">MessageQueue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SnowflakeIdGenerator"><span class="toc-number">4.2.6.</span> <span class="toc-text">SnowflakeIdGenerator</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Commands"><span class="toc-number">5.</span> <span class="toc-text">Commands</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JAVA%E7%A8%8B%E5%BA%8F"><span class="toc-number">6.</span> <span class="toc-text">JAVA程序</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Client-java"><span class="toc-number">6.1.</span> <span class="toc-text">Client.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Server-java"><span class="toc-number">6.2.</span> <span class="toc-text">Server.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SnowflakeldGenerator-java"><span class="toc-number">6.3.</span> <span class="toc-text">SnowflakeldGenerator.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TextSaverApp"><span class="toc-number">6.4.</span> <span class="toc-text">TextSaverApp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MessageQueue-1"><span class="toc-number">6.5.</span> <span class="toc-text">MessageQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Message"><span class="toc-number">6.6.</span> <span class="toc-text">Message</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MessageUtils"><span class="toc-number">6.7.</span> <span class="toc-text">MessageUtils</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C"><span class="toc-number">7.</span> <span class="toc-text">实现效果</span></a></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1727008967240"></script>

<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





</body>

</html>
